# Webpay Service - Multi-Tenant

Microservicio basado en FastAPI que expone endpoints de integraciÃ³n con Webpay Plus de Transbank y sincronizaciÃ³n automÃ¡tica con Odoo ERP. El servicio **soporta mÃºltiples clientes** en una Ãºnica instancia, identificando automÃ¡ticamente al cliente por el dominio de origen.

## ğŸš€ CaracterÃ­sticas principales

- âœ… **Multi-tenant (mÃºltiples clientes)** - Un servidor para todos tus clientes
- âœ… **IdentificaciÃ³n automÃ¡tica de cliente** - Por dominio de origen
- âœ… **IntegraciÃ³n completa con Webpay Plus** - Manejo de transacciones de pago
- âœ… **SincronizaciÃ³n automÃ¡tica con Odoo** - ActualizaciÃ³n de Ã³rdenes de venta
- âœ… **GestiÃ³n de transacciones** - Registro y seguimiento de pagos
- âœ… **CORS configurado** - Listo para integraciÃ³n con Odoo Online
- âœ… **Manejo de errores robusto** - Logs detallados y fallbacks
- âœ… **API REST documentada** - Endpoints para todas las operaciones

## ğŸ“‹ Requisitos previos

- Python 3.10 o superior (`python3 --version`)
- `pip` actualizado (`python3 -m pip install --upgrade pip`)
- Acceso a internet para instalar dependencias
- Archivo `clients.yaml` configurado con tus clientes (ver secciÃ³n de configuraciÃ³n)

## ğŸ”§ ConfiguraciÃ³n del entorno

### 1. PreparaciÃ³n del entorno

1. Clonar o descargar este repositorio dentro de tu workspace.
2. Crear un entorno virtual: `python3 -m venv venv`
3. Activar el entorno:
   - macOS/Linux: `source venv/bin/activate`
   - Windows PowerShell: `.\venv\Scripts\activate.bat`
   - Windows CMD: `venv\Scripts\activate.bat`
   - Si tienes permisos de PowerShell: `.\venv\Scripts\Activate.ps1`
4. Opcional: actualizar herramientas base dentro del entorno activado.

Para desactivar el entorno basta con ejecutar `deactivate`.

### 2. InstalaciÃ³n de dependencias

Con el entorno activo instala los paquetes necesarios:

```bash
pip install -r requirements.txt
```

### 3. ConfiguraciÃ³n de variables globales (.env)

Crear un archivo `.env` en la raÃ­z del proyecto con la **configuraciÃ³n global** del servicio:

```bash
# ğŸ”’ ConfiguraciÃ³n de seguridad global
API_KEY=tu-api-key-segura-aqui
HMAC_SECRET=tu-secreto-hmac-super-seguro-aqui
INTERNAL_TOKEN=middleware-odoo-secure-token-2025
TIMESTAMP_TOLERANCE=300

# ğŸŒ ConfiguraciÃ³n del servicio
SERVICE_BASE_URL=https://tu-servicio.com
LOG_LEVEL=INFO
```

### 4. ConfiguraciÃ³n de clientes (clients.yaml)

**âš ï¸ NUEVO EN v2.0.0**: Las credenciales especÃ­ficas de cada cliente ahora se configuran en `clients.yaml`

1. Copia el archivo de ejemplo:
```bash
cp clients.yaml.example clients.yaml
```

2. Edita `clients.yaml` y configura tus clientes:

```yaml
clients:
  tecnogrow:
    client_id: "tecnogrow"
    client_name: "Tecnogrow"
    
    # Dominios permitidos (para CORS y identificaciÃ³n)
    allowed_origins:
      - "https://tecnogrow-integration.odoo.com"
      - "https://tecnogrow.odoo.com"
    
    # ConfiguraciÃ³n de Odoo
    odoo:
      url: "https://tecnogrow-integration.odoo.com"
      database: "tecnogrow-integration"
      username: "admin@tecnogrow.cl"
      password: "tu_password"
    
    # ConfiguraciÃ³n de Webpay
    webpay:
      provider_id: 20
      payment_method_id: 209
    
    enabled: true

  # Puedes agregar mÃ¡s clientes aquÃ­
  cliente2:
    client_id: "cliente2"
    client_name: "Cliente 2 S.A."
    allowed_origins:
      - "https://cliente2.odoo.com"
    odoo:
      url: "https://cliente2.odoo.com"
      database: "cliente2-prod"
      username: "admin@cliente2.com"
      password: "otro_password"
    webpay:
      provider_id: 25
      payment_method_id: 215
    enabled: true
```

**ğŸ“– DocumentaciÃ³n completa**: Ver [MULTI_TENANT.md](MULTI_TENANT.md) para detalles sobre configuraciÃ³n multi-cliente.

## ğŸš€ Ejecutar el microservicio

1. AsegÃºrate de tener el entorno virtual activo.
2. Configura las variables de entorno necesarias (`.env`).
3. Configura tus clientes en `clients.yaml`.
4. Inicia el servidor de desarrollo:

```bash
uvicorn src.main:app --reload --host 0.0.0.0 --port 8000
```

5. Abre `http://localhost:8000` para verificar el estado.
6. La documentaciÃ³n interactiva de FastAPI estÃ¡ disponible en `http://localhost:8000/docs`.

## ğŸ“Š Endpoints disponibles

### ğŸ  Endpoints generales

| MÃ©todo | Ruta       | DescripciÃ³n                                    | AutenticaciÃ³n |
|--------|------------|------------------------------------------------|---------------|
| GET    | `/`        | Verifica que el microservicio estÃ© operativo y lista clientes activos | âŒ No |
| GET    | `/health`  | Health check detallado del sistema            | âŒ No         |

**Respuesta de `/`:**
```json
{
  "status": "ok",
  "message": "Webpay Service operativo - Multi-tenant",
  "version": "2.0.0",
  "clients_count": 2,
  "clients": ["Tecnogrow", "Cliente 2 S.A."]
}
```

### ğŸ’³ Endpoints de Webpay

| MÃ©todo | Ruta             | DescripciÃ³n                                               | AutenticaciÃ³n |
|--------|------------------|-----------------------------------------------------------|---------------|
| POST   | `/webpay/init`   | Crea un token de transacciÃ³n (identifica cliente automÃ¡ticamente) | âœ… Origin*   |
| POST   | `/webpay/commit` | Recibe el callback de Webpay (mÃ©todo POST)              | âŒ No**        |
| GET    | `/webpay/commit` | Maneja respuestas de Webpay vÃ­a GET                      | âŒ No**        |

*AutenticaciÃ³n por origen: El sistema identifica al cliente por el dominio del header `Origin`
**Los endpoints de commit no requieren autenticaciÃ³n porque son llamados directamente por Transbank.

### ğŸª Endpoints de Odoo

| MÃ©todo | Ruta                            | DescripciÃ³n                                     | AutenticaciÃ³n        |
|--------|---------------------------------|-------------------------------------------------|----------------------|
| GET    | `/odoo/orders/search`           | Busca Ã³rdenes por criterios especÃ­ficos        | âœ… API Key           |
| GET    | `/odoo/orders/{order_id}`       | Obtiene detalles de una orden especÃ­fica       | âœ… API Key           |
| PUT    | `/odoo/orders/{id}/status`      | Actualiza el estado de una orden               | âœ… API Key           |
| POST   | `/odoo/payments/create`         | Crea una transacciÃ³n de pago manualmente       | âœ… API Key + HMAC    |
| GET    | `/odoo/health`                  | Verifica la conexiÃ³n con Odoo                  | âœ… API Key           |



## ğŸ”„ Flujo de integraciÃ³n completo

### 1. Flujo de pago multi-tenant

1. **Frontend de Odoo hace la llamada**: Desde JavaScript en el sitio de Odoo
   ```javascript
   fetch('https://tu-servicio.com/webpay/init', {
     method: 'POST',
     headers: { 'Content-Type': 'application/json' },
     body: JSON.stringify({
       amount: 10000,
       customer_name: "Juan PÃ©rez",
       order_date: "2025-11-26"
     })
   })
   ```

2. **IdentificaciÃ³n automÃ¡tica**: El sistema:
   - Lee el header `Origin` (ej: `https://tecnogrow-integration.odoo.com`)
   - Identifica que corresponde al cliente "Tecnogrow"
   - Usa las credenciales especÃ­ficas de Tecnogrow

3. **RedirecciÃ³n a Webpay**: Utiliza el `token` y la `url` para redirigir al formulario Webpay.

4. **ConfirmaciÃ³n automÃ¡tica**: Webpay envÃ­a la respuesta al endpoint `/webpay/commit`.

5. **SincronizaciÃ³n con Odoo del cliente correcto**: El sistema:
   - Identifica al cliente desde el resultado
   - Busca la orden en el Odoo correspondiente
   - Actualiza el estado de la orden a 'sale'
   - Registra la transacciÃ³n de pago
   - Vincula la transacciÃ³n con la orden

### 2. Agregar un nuevo cliente

Simplemente edita `clients.yaml` y agrega el nuevo bloque:

```yaml
nuevo_cliente:
  client_id: "nuevo_cliente"
  client_name: "Nuevo Cliente S.A."
  allowed_origins:
    - "https://nuevo-cliente.odoo.com"
  odoo:
    url: "https://nuevo-cliente.odoo.com"
    database: "nuevo-cliente-db"
    username: "admin@nuevo-cliente.com"
    password: "password_seguro"
  webpay:
    provider_id: 30
    payment_method_id: 220
  enabled: true
```

No se requiere reiniciar el servidor (opcional hot-reload).

### 2. BÃºsqueda manual de Ã³rdenes

```bash
GET /odoo/orders/search?customer_name=Juan&amount=10000&order_date=2025-10-30
```

### 3. CreaciÃ³n manual de transacciones

```json
POST /odoo/payments/create
{
  "order_id": 123,
  "order_name": "SO001",
  "amount": 10000.0,
  "status": "done",
  "payment_data": {
    "authorization_code": "ABC123",
    "buy_order": "Juan-Perez_10000_20251030"
  }
}
```

## âš ï¸ CONFIGURACIÃ“N CRÃTICA - WEBPAY PROVIDERS POR CLIENTE

> **âš ï¸ IMPORTANTE**: Cada cliente debe tener configurados correctamente sus IDs de provider y mÃ©todo de pago en `clients.yaml`:

```yaml
webpay:
  provider_id: 20        # ID del provider Webpay en Odoo del cliente
  payment_method_id: 209 # ID del mÃ©todo de pago Webpay en Odoo del cliente
```

### ğŸ” CÃ³mo obtener los IDs correctos para cada cliente:

1. Acceder a la instancia de Odoo del cliente
2. Ir a **FacturaciÃ³n > ConfiguraciÃ³n > Proveedores de pago**
3. Buscar el proveedor "Webpay" y anotar su ID
4. En **Contabilidad > ConfiguraciÃ³n > MÃ©todos de pago**, buscar "Webpay" y anotar su ID
5. Actualizar los valores en `clients.yaml` para ese cliente

**âŒ Si estos valores son incorrectos, las transacciones NO se registrarÃ¡n correctamente en Odoo del cliente.**

## ğŸ—ï¸ Estructura del proyecto actualizada (v2.0.0)

```
webpay_service/
â”œâ”€â”€ README.MD                # DocumentaciÃ³n principal
â”œâ”€â”€ MULTI_TENANT.md          # ğŸ†• GuÃ­a de configuraciÃ³n multi-cliente
â”œâ”€â”€ requirements.txt         # Dependencias Python (incluye PyYAML)
â”œâ”€â”€ .env                     # Variables globales (no versionado)
â”œâ”€â”€ .gitignore
â”œâ”€â”€ clients.yaml             # ğŸ†• ConfiguraciÃ³n de clientes (no versionado)
â”œâ”€â”€ clients.yaml.example     # ğŸ†• Plantilla de configuraciÃ³n
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py             # AplicaciÃ³n principal FastAPI
â”‚   â”œâ”€â”€ config.py           # Configuraciones centralizadas (multi-tenant)
â”‚   â”œâ”€â”€ client_config.py    # ğŸ†• GestiÃ³n de configuraciÃ³n de clientes
â”‚   â”œâ”€â”€ security.py         # ğŸ”’ MÃ³dulo de seguridad (identifica clientes)
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”œâ”€â”€ webpay_routes.py    # Endpoints de Webpay (multi-tenant)
â”‚   â”‚   â””â”€â”€ odoo_routes.py      # Endpoints de Odoo (protegidos)
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ webpay_service.py   # LÃ³gica de Webpay
â”‚   â”‚   â””â”€â”€ odoo_sales.py       # IntegraciÃ³n con Odoo (multi-tenant)
â””â”€â”€ venv/                   # Entorno virtual (no versionado)
```

## ğŸ”„ Funcionalidades de integraciÃ³n con Odoo

### BÃºsqueda inteligente de Ã³rdenes
- BÃºsqueda por nombre de cliente (coincidencia parcial)
- BÃºsqueda por monto exacto
- BÃºsqueda por fecha de orden
- CombinaciÃ³n de mÃºltiples criterios

### Manejo automÃ¡tico de estados
- ConfirmaciÃ³n automÃ¡tica de Ã³rdenes despuÃ©s del pago
- Manejo de errores de stock (forzar estado 'sale')
- Registro de notas de pago en las Ã³rdenes

### GestiÃ³n de transacciones
- CreaciÃ³n automÃ¡tica de payment.transaction
- VinculaciÃ³n con Ã³rdenes de venta
- Soporte para mÃºltiples monedas
- Manejo de cÃ³digos de autorizaciÃ³n y referencias

## ğŸ§ª Datos de prueba

### URL de prueba Webpay
```
https://webpay3gint.transbank.cl/webpayserver/initTransaction?token_ws=01ab3321e3f70dedc382e6a09d54a9665bd6422d4eedf6bcf407a43b00a0a3e1
```

### Tarjeta de prueba
```
NÃºmero: 4051 8856 0044 6623
Fecha: 05/28
CVV: 123
```

### Cuenta de prueba RUT
```
RUT: 11.111.111-1
Clave: 123
```

## ğŸš€ PrÃ³ximas mejoras

- [x] **ConfiguraciÃ³n multi-tenant** - MÃºltiples clientes en un servidor
- [x] **IdentificaciÃ³n automÃ¡tica de cliente** - Por dominio de origen
- [ ] Manejo de mÃºltiples proveedores de pago por cliente
- [ ] Dashboard de monitoreo de transacciones
- [ ] Notificaciones automÃ¡ticas por email
- [ ] IntegraciÃ³n con webhooks de Odoo
- [ ] Tests automatizados completos
- [ ] MÃ©tricas y logging avanzado
- [ ] Hot-reload de configuraciÃ³n sin reiniciar

## ğŸ“š DocumentaciÃ³n adicional

- **[MULTI_TENANT.md](MULTI_TENANT.md)** - GuÃ­a completa de configuraciÃ³n multi-cliente
- **[clients.yaml.example](clients.yaml.example)** - Plantilla de configuraciÃ³n
- **/docs** - DocumentaciÃ³n interactiva de la API (cuando el servidor estÃ¡ ejecutÃ¡ndose)

## url de prueba
https://webpay3gint.transbank.cl/webpayserver/initTransaction?token_ws=01ab3321e3f70dedc382e6a09d54a9665bd6422d4eedf6bcf407a43b00a0a3e1
