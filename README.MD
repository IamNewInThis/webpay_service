# Webpay Service

Microservicio basado en FastAPI que expone endpoints de integraciÃ³n con Webpay Plus de Transbank y sincronizaciÃ³n automÃ¡tica con Odoo ERP. El servicio permite iniciar transacciones, recibir confirmaciones de Webpay y actualizar automÃ¡ticamente las Ã³rdenes de venta en Odoo.

## ğŸš€ CaracterÃ­sticas principales

- âœ… **IntegraciÃ³n completa con Webpay Plus** - Manejo de transacciones de pago
- âœ… **SincronizaciÃ³n automÃ¡tica con Odoo** - ActualizaciÃ³n de Ã³rdenes de venta
- âœ… **GestiÃ³n de transacciones** - Registro y seguimiento de pagos
- âœ… **CORS configurado** - Listo para integraciÃ³n con Odoo Online
- âœ… **Manejo de errores robusto** - Logs detallados y fallbacks
- âœ… **API REST documentada** - Endpoints para todas las operaciones

## ğŸ“‹ Requisitos previos

- Python 3.10 o superior (`python3 --version`)
- `pip` actualizado (`python3 -m pip install --upgrade pip`)
- Acceso a internet para instalar dependencias
- Variables de entorno configuradas para Odoo (ver secciÃ³n de configuraciÃ³n)

## ğŸ”§ ConfiguraciÃ³n del entorno

### 1. PreparaciÃ³n del entorno

1. Clonar o descargar este repositorio dentro de tu workspace.
2. Crear un entorno virtual: `python3 -m venv venv`
3. Activar el entorno:
   - macOS/Linux: `source venv/bin/activate`
   - Windows PowerShell: `.\venv\Scripts\activate.bat`
   - Windows CMD: `venv\Scripts\activate.bat`
   - Si tienes permisos de PowerShell: `.\venv\Scripts\Activate.ps1`
4. Opcional: actualizar herramientas base dentro del entorno activado.

Para desactivar el entorno basta con ejecutar `deactivate`.

### 2. Variables de entorno

Crear un archivo `.env` en la raÃ­z del proyecto con las siguientes variables:

```bash
# ğŸ”‘ ConfiguraciÃ³n de Odoo
ODOO_URL=https://tu-instancia.odoo.com
ODOO_DATABASE=tu_base_de_datos
ODOO_USERNAME=tu_usuario
ODOO_PASSWORD=tu_contraseÃ±a

# ğŸ”’ ConfiguraciÃ³n de seguridad
API_KEY=tu-api-key-segura-aqui
HMAC_SECRET=tu-secreto-hmac-super-seguro-aqui
TIMESTAMP_TOLERANCE=300

# ğŸ’³ ConfiguraciÃ³n de Webpay (fallback)
WEBPAY_ENVIRONMENT=TEST
WEBPAY_COMMERCE_CODE=5970XXXXXXXX
WEBPAY_API_KEY=tu-api-key-webpay

# ğŸŒ ConfiguraciÃ³n del servicio
SERVICE_BASE_URL=https://tu-servicio.onrender.com
LOG_LEVEL=INFO

# ğŸ§© ConfiguraciÃ³n multi-tenant (opcional)
TENANT_CONFIGS='[
  {
    "id": "***id***",
    "name": "***name***",
    "origins": ["***https://<tu-dominio>.odoo.com***"],
    "odoo": {
      "url": "***https://<tu-dominio>.odoo.com***",
      "database": "***your-database-name***",
      "username": "***your-username***",
      "password": "********"
    },
    "webpay": {
      "commerce_code": "***tu-commerce-code***",
      "api_key": "***tu-api-key-webpay***",
      "environment": "PROD"
    }
  },
  {
    "id": "simpledigital",
    "name": "Simple Digital",
    "origins": [
      "***https://<tu-dominio>.odoo.com***",
      "***https://<tu-dominio>.com***"
    ],
    "odoo": {
      "url": "***https://<tu-dominio>.odoo.com***",
      "database": "***your-database-name***",
      "username": "***your-username***",
      "password": "********"
    },
    "webpay": {
      "commerce_code": "***tu-commerce-code***",
      "api_key": "***tu-api-key-webpay***",
      "environment": "TEST"
    }
  }
]'
```

> Si `TENANT_CONFIGS` no estÃ¡ definido, el servicio utilizarÃ¡ las variables `ODOO_*` y `WEBPAY_*` del `.env` como tenant por defecto. Cada origen definido se valida automÃ¡ticamente en CORS y en el middleware `verify_frontend_request`, y el ambiente de Webpay se determina con `WEBPAY_ENVIRONMENT` (`TEST` o `PROD`).

### 3. InstalaciÃ³n de dependencias

Con el entorno activo instala los paquetes necesarios:

```bash
pip install -r requirements.txt
```

Puedes congelar la lista para despliegues posteriores:

```bash
pip freeze > requirements.txt
```

## ğŸš€ Ejecutar el microservicio

1. AsegÃºrate de tener el entorno virtual activo.
2. Configura las variables de entorno necesarias.
3. Inicia el servidor de desarrollo:

```bash
uvicorn src.main:app --reload --host 0.0.0.0 --port 8000
```

4. Abre `http://localhost:8000` para verificar el estado.
5. La documentaciÃ³n interactiva de FastAPI estÃ¡ disponible en `http://localhost:8000/docs`.

## ğŸ“Š Endpoints disponibles

### ğŸ  Endpoints generales

| MÃ©todo | Ruta       | DescripciÃ³n                                    | AutenticaciÃ³n |
|--------|------------|------------------------------------------------|---------------|
| GET    | `/`        | Verifica que el microservicio estÃ© operativo  | âŒ No         |
| GET    | `/health`  | Health check detallado del sistema            | âŒ No         |

### ğŸ’³ Endpoints de Webpay

| MÃ©todo | Ruta             | DescripciÃ³n                                               | AutenticaciÃ³n |
|--------|------------------|-----------------------------------------------------------|---------------|
| POST   | `/webpay/init`   | Crea un token de transacciÃ³n contra el ambiente de prueba| âœ… API Key    |
| POST   | `/webpay/commit` | Recibe el callback de Webpay (mÃ©todo POST)              | âŒ No*        |
| GET    | `/webpay/commit` | Maneja respuestas de Webpay vÃ­a GET                      | âŒ No*        |

*Los endpoints de commit no requieren autenticaciÃ³n porque son llamados directamente por Transbank.

### ğŸª Endpoints de Odoo

| MÃ©todo | Ruta                            | DescripciÃ³n                                     | AutenticaciÃ³n        |
|--------|---------------------------------|-------------------------------------------------|----------------------|
| GET    | `/odoo/orders/search`           | Busca Ã³rdenes por criterios especÃ­ficos        | âœ… API Key           |
| GET    | `/odoo/orders/{order_id}`       | Obtiene detalles de una orden especÃ­fica       | âœ… API Key           |
| PUT    | `/odoo/orders/{id}/status`      | Actualiza el estado de una orden               | âœ… API Key           |
| POST   | `/odoo/payments/create`         | Crea una transacciÃ³n de pago manualmente       | âœ… API Key + HMAC    |
| GET    | `/odoo/health`                  | Verifica la conexiÃ³n con Odoo                  | âœ… API Key           |



## ğŸ”„ Flujo de integraciÃ³n completo

### 1. Flujo de pago estÃ¡ndar

1. **InicializaciÃ³n**: Invoca `POST /webpay/init` con:
   ```json
   {
     "amount": 10000,
     "customer_name": "Juan PÃ©rez",
     "order_date": "2025-10-30"
   }
   ```

2. **RedirecciÃ³n**: Utiliza el `token` y la `url` para redirigir al cliente al formulario Webpay.

3. **ConfirmaciÃ³n**: Webpay envÃ­a la respuesta al endpoint `/webpay/commit`.

4. **SincronizaciÃ³n automÃ¡tica**: El sistema:
   - Busca la orden correspondiente en Odoo
   - Actualiza el estado de la orden a 'sale'
   - Registra la transacciÃ³n de pago
   - Vincula la transacciÃ³n con la orden

### 2. BÃºsqueda manual de Ã³rdenes

```bash
GET /odoo/orders/search?customer_name=Juan&amount=10000&order_date=2025-10-30
```

### 3. CreaciÃ³n manual de transacciones

```json
POST /odoo/payments/create
{
  "order_id": 123,
  "order_name": "SO001",
  "amount": 10000.0,
  "status": "done",
  "payment_data": {
    "authorization_code": "ABC123",
    "buy_order": "Juan-Perez_10000_20251030"
  }
}
```

## âš ï¸ CONFIGURACIÃ“N CRÃTICA - ODOO PAYMENT PROVIDERS

> **âš ï¸ IMPORTANTE**: Las siguientes variables son fundamentales para el correcto funcionamiento del servicio:

```python
provider_id = 00        # Provider Webpay configurado en Odoo
payment_method_id = 000 # MÃ©todo de pago Webpay configurado en Odoo
```

**DEBE VERIFICAR Y ACTUALIZAR** estos valores en el archivo `src/services/odoo_sales.py` segÃºn la configuraciÃ³n especÃ­fica de su instancia de Odoo:

1. **provider_id**: ID del proveedor de pago Webpay en su configuraciÃ³n de Odoo
2. **payment_method_id**: ID del mÃ©todo de pago Webpay en su configuraciÃ³n de Odoo

### ğŸ” CÃ³mo obtener los IDs correctos:

1. En Odoo, ir a **FacturaciÃ³n > ConfiguraciÃ³n > Proveedores de pago**
2. Buscar el proveedor "Webpay" y anotar su ID
3. En **Contabilidad > ConfiguraciÃ³n > MÃ©todos de pago**, buscar "Webpay" y anotar su ID
4. Actualizar las variables en el cÃ³digo antes del despliegue

**âŒ Si estos valores son incorrectos, las transacciones NO se registrarÃ¡n correctamente en Odoo.**

## ğŸ—ï¸ Estructura del proyecto actualizada

```
webpay_service/
â”œâ”€â”€ README.MD
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ .env                     # Variables de entorno (no versionado)
â”œâ”€â”€ .gitignore
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py             # AplicaciÃ³n principal FastAPI
â”‚   â”œâ”€â”€ config.py           # Configuraciones centralizadas
â”‚   â”œâ”€â”€ security.py         # ğŸ”’ MÃ³dulo de seguridad (API Key + HMAC)
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”œâ”€â”€ webpay_routes.py    # Endpoints de Webpay
â”‚   â”‚   â””â”€â”€ odoo_routes.py      # Endpoints de Odoo (protegidos)
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ webpay_service.py   # LÃ³gica de Webpay
â”‚   â”‚   â””â”€â”€ odoo_sales.py       # IntegraciÃ³n con Odoo
â”œâ”€â”€ tests/
â”‚   â””â”€â”€ test_security.py    # ğŸ§ª Tests de seguridad
â””â”€â”€ venv/                   # Entorno virtual (no versionado)
```

## ğŸ”„ Funcionalidades de integraciÃ³n con Odoo

### BÃºsqueda inteligente de Ã³rdenes
- BÃºsqueda por nombre de cliente (coincidencia parcial)
- BÃºsqueda por monto exacto
- BÃºsqueda por fecha de orden
- CombinaciÃ³n de mÃºltiples criterios

### Manejo automÃ¡tico de estados
- ConfirmaciÃ³n automÃ¡tica de Ã³rdenes despuÃ©s del pago
- Manejo de errores de stock (forzar estado 'sale')
- Registro de notas de pago en las Ã³rdenes

### GestiÃ³n de transacciones
- CreaciÃ³n automÃ¡tica de payment.transaction
- VinculaciÃ³n con Ã³rdenes de venta
- Soporte para mÃºltiples monedas
- Manejo de cÃ³digos de autorizaciÃ³n y referencias

## ğŸ§ª Datos de prueba

### URL de prueba Webpay
```
https://webpay3gint.transbank.cl/webpayserver/initTransaction?token_ws=01ab3321e3f70dedc382e6a09d54a9665bd6422d4eedf6bcf407a43b00a0a3e1
```

### Tarjeta de prueba
```
NÃºmero: 4051 8856 0044 6623
Fecha: 05/28
CVV: 123
```

### Cuenta de prueba RUT
```
RUT: 11.111.111-1
Clave: 123
```

## ğŸš€ PrÃ³ximas mejoras
- [ ] Dashboard de monitoreo de transacciones
- [ ] Notificaciones automÃ¡ticas por email
- [ ] IntegraciÃ³n con webhooks de Odoo
- [ ] Tests automatizados completos
- [ ] MÃ©tricas y logging avanzado

## url de prueba
https://webpay3gint.transbank.cl/webpayserver/initTransaction?token_ws=01ab3321e3f70dedc382e6a09d54a9665bd6422d4eedf6bcf407a43b00a0a3e1

# Despliegue del contenedor

- Crear la imagen Docker:
```bash
docker build -t webpay_service .
```

- Correr el contenedor:
```bash
docker run -d \
  --name webpay_container \
  -p 8000:8000 \
  -e ODOO_DATABASE="tecnogrow-webpay" \
  -e ODOO_PASSWORD="Ab67d7654.123" \
  -e ODOO_URL="https://tecnogrow-webpay.odoo.com" \
  -e ODOO_USERNAME="admin@tecnogrow.cl" \
  webpay_service
```
